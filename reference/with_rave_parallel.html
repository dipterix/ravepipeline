<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Internal parallel functions — with_rave_parallel • ravepipeline</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internal parallel functions — with_rave_parallel"><meta name="description" content="Experimental parallel functions, intended for internal use now. The goal
is to allow 'RAVE' functions to gain the potential benefit from parallel
computing, but allow users to control whether to do it."><meta property="og:description" content="Experimental parallel functions, intended for internal use now. The goal
is to allow 'RAVE' functions to gain the potential benefit from parallel
computing, but allow users to control whether to do it."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ravepipeline</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/using-pipeline-class.html">Using RAVE Pipelines Programmatically</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/dipterix/ravepipeline/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Internal parallel functions</h1>
      <small class="dont-index">Source: <a href="https://github.com/dipterix/ravepipeline/blob/main/R/parallel-lapply_jobs.R" class="external-link"><code>R/parallel-lapply_jobs.R</code></a></small>
      <div class="d-none name"><code>with_rave_parallel.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Experimental parallel functions, intended for internal use now. The goal
is to allow 'RAVE' functions to gain the potential benefit from parallel
computing, but allow users to control whether to do it.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">with_rave_parallel</span><span class="op">(</span><span class="va">expr</span>, .workers <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">lapply_jobs</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">fun</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  .globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .workers <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  .always <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  callback <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>expression to evaluate with parallel workers</p></dd>


<dt id="arg--workers">.workers<a class="anchor" aria-label="anchor" href="#arg--workers"></a></dt>
<dd><p>number of workers: note the actual numbers may differ,
depending on the options and number of input elements</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>a list, vector, array of R objects</p></dd>


<dt id="arg-fun">fun<a class="anchor" aria-label="anchor" href="#arg-fun"></a></dt>
<dd><p>function to apply to each element of <code>x</code></p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>additional arguments to be passed to <code>fun</code></p></dd>


<dt id="arg--globals">.globals<a class="anchor" aria-label="anchor" href="#arg--globals"></a></dt>
<dd><p>global variables to be serialized</p></dd>


<dt id="arg--always">.always<a class="anchor" aria-label="anchor" href="#arg--always"></a></dt>
<dd><p>whether always use workers, only considered when number of
workers is one; default is false, then run jobs in the main process when
only one worker is required</p></dd>


<dt id="arg-callback">callback<a class="anchor" aria-label="anchor" href="#arg-callback"></a></dt>
<dd><p>callback function, input is each element of <code>x</code> and
should return a string, for progress bar</p></dd>


<dt id="arg-workers">workers<a class="anchor" aria-label="anchor" href="#arg-workers"></a></dt>
<dd><p>number of workers</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>By default, <code>lapply_jobs</code> is almost identical to <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></code>.
It only runs in parallel when running inside of <code>with_rave_parallel</code>.</p>
<p>The hard max-limit number of workers are determined by the 'RAVE' option
<code>raveio_getopt('max_worker')</code>. Users can lower this number for
memory-intensive tasks manually, via argument <code>.workers</code>.
The actual number of workers might be less than the requested ones, this
is often a result of sort input <code>x</code>. If the number of input iterations
has fewer than the max worker size, then the number of workers automatically
shrinks to the length of input list. All workers will be a child process
running separate from the main session, except for when only one worker
is needed and <code>.always=FALSE</code>: the only task will be executed in the
main session.</p>
<p>Each worker session will run a completely isolated new process. There is
a ramp-up serialization that is needed for global objects (objects that
are defined elsewhere or outside of the function). Please make sure
the global objects are specified explicitly in <code>.globals</code>, a named list.
Unlike <code>future</code> package, users must specify the global objects.</p>
<p>The global objects might be large to serialize. Please optimize the code
to avoid serializing big objects, especially environments or functions.
All objects inheriting <code><a href="RAVESerializable.html">RAVESerializable</a></code> class with
<code>@marshal</code> and <code>@unmarshal</code> methods implemented correctly will
be serialized with reference hook <code>rave_serialize_refhook</code>, making
them extremely efficient.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run without `with_rave_parallel`</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">lapply_jobs</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>child <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       [,1] [,2] [,3] [,4] [,5]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> child 7561 7561 7561 7561 7561</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> main  7561 7561 7561 7561 7561</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Comparison</span></span></span>
<span class="r-in"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">5</span>, <span class="va">workers</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="fu">ravepipeline</span><span class="fu">::</span><span class="fu">lapply_jobs</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>child <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span>, .workers <span class="op">=</span> <span class="va">workers</span>, callback <span class="op">=</span> <span class="va">I</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Without parallel</span></span></span>
<span class="r-in"><span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#&gt;    user  system elapsed</span></span></span>
<span class="r-in"><span><span class="co">#&gt;   0.022   0.019   5.010</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># with parallel</span></span></span>
<span class="r-in"><span><span class="fu">with_rave_parallel</span><span class="op">(</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu">f</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">#&gt;    user  system elapsed</span></span></span>
<span class="r-in"><span><span class="co">#&gt;   0.729   0.190   1.460</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zhengjia Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

